{% extends "analytics/base.html" %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'styles/index.css' %}">

<div class="main-content">
  <div class="container-fluid">
    
    <!-- Primeira linha: Cards principais e Mercados laterais -->
    <div class="row mt-2 mb-4">
      <!-- Cards principais (8 colunas) -->
      <div class="col-lg-9">
        {% comment %} <div class="main-cards-scroll-container"> {% endcomment %}
          <div class="row g-3">
            <!-- Card Gerência Apostas -->
            <div class="col-xl-6 col-md-6">
              <a href="{% url 'gerencia:index' %}" class="text-decoration-none">
                <div class="card border-left-primary shadow h-100 py-2">
                  <div class="card-body">
                    <div class="row no-gutters">
                      <div class="col-4 mr-2">
                        <div class="font-weight-bold text-primary mb-1">
                          Total Ganhos
                        </div>
                        <div class="h6 mb-0 font-weight-bold text-gray-800 d-flex align-items-center">
                          <span class="bi bi-cash-coin text-gray-300 me-2"></span>
                          <span class="text-gray-300" style="margin-top: -15px;">R$ {{ soma_total_retorno }}</span>
                        </div>
                        <div class="font-weight-bold text-primary mb-1 mt-1">
                          Retorno Semanal
                        </div>
                        <div class="h6 mb-0 font-weight-bold text-gray-800 d-flex align-items-center">
                          <span class="bi bi-cash-coin text-gray-300 me-2"></span>
                          <span class="text-gray-300" style="margin-top: -15px;">R$ {{ retorno_atual }}</span>
                        </div>
                      </div>
                      <div class="col-4 mr-2">
                        <div id="graficoResultadoAposta">
                          <!-- O gráfico será renderizado aqui via JavaScript -->
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </a>
            </div>

            <!-- Card Quantidade Eventos -->
            <div class="col-xl-6 col-md-6">
              <a class="text-decoration-none">
                <div class="card border-left-success shadow h-100 py-2">
                  <div class="card-body">
                    <div class="row no-gutters">
                      <div class="col-md-4">
                        <div class="font-weight-bold text-successmb-1">
                          Qtd. Eventos
                        </div>
                        <div class="h6 mb-0 font-weight-bold text-gray-800 d-flex">
                          <span class="text-gray-300"> <span class="bi bi-box2 text-gray-300"></span> {{ qtd_eventos }}</span>
                        </div>
                        <div class="font-weight-bold text-success mt-1" id="proximoEventoLabel">
                          Próximo Evento
                        </div>
                        <div class="h6 mb-0 font-weight-bold text-gray-800">
                          <span class="fs-4 text-gray-300" id="proximoEvento"></span>
                        </div>
                        <div class="font-weight-bold text-success mt-1" id="tempoRestandoLabel">
                          Tempo Restando
                        </div>
                        <div class="h6 mb-0 font-weight-bold text-gray-800">
                          <span class="fs-4 text-gray-300" id="tempoRestando"></span>
                        </div>
                      </div>
                      <div class="col md-2">
                        <div id="graficoMelhorDia">
                          <!-- O gráfico será renderizado aqui via JavaScript -->
                        </div>
                      </div>
                      
                    </div>
                  </div>
                </div>
              </a>
            </div>

            <!-- Card Performance -->
            <div class="col-xl-6 col-md-6">
              <a href="#" class="text-decoration-none">
                <div class="card border-left-info shadow h-100">
                  <div class="card-body">
                    <div class="row no-gutters align-items-center">
                      <div class="col mr-2">
                        <div class="font-weight-bold text-info mb-1">
                          Performance
                        </div>
                        <div class="row no-gutters align-items-center">
                          <div class="col-auto">
                            <div class="h6 mb-0 mr-3 font-weight-bold text-gray-800">
                              <span id="textoProgressBar" class="text-gray-300"></span>
                            </div>
                          </div>
                          <div class="col">
                            <div class="progress progress-sm mr-2">
                              <div id="progressPerformace" class="progress-bar" role="progressbar"></div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-auto">
                        <i class="bi bi-graph-up-arrow fs-2 text-gray-300"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </a>
            </div>

            <!-- Card Ciclos -->
            <div class="col-xl-6 col-md-6">
              <a href="{% url 'ciclo:index' %}" class="text-decoration-none">
                <div class="card border-left-warning shadow h-100">
                  <div class="card-body">
                    <div class="row no-gutters align-items-center">
                      <div class="col mr-1">
                        <div class="font-weight-bold text-warning mb-1">
                          Ciclos
                        </div>
                        <div class="h6 mb-0 font-weight-bold text-gray-800">
                          <span class="text-gray-300">{{ qtd_ciclos }}</span>
                        </div>
                      </div>
                      <div class="col mr-1">
                        <div class="font-weight-bold text-warning mb-1">
                          Último Ciclo
                        </div>
                        <div class="h6 mb-0 font-weight-bold text-gray-800">
                          <span class="text-gray-300">{{ ciclo_atual }}</span>
                        </div>
                      </div>
                      <div class="col mr-1">
                        <div class="font-weight-bold text-warning mb-1">
                          Disponível
                        </div>
                        <div class="h6 mb-0 font-weight-bold text-gray-800">
                         <span class="text-gray-300">R$ <span id="valor-total-disponivel">{{ ciclo_atual_disponivel }}</span></span>
                        </div>
                      </div>
                      <div class="col-auto">
                        <i class="bi bi-bell fs-2 text-gray-300"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </a>
            </div>

            <!-- Segunda linha: Lista de Mercados -->
          <div class="main-cards-scroll-container">
            <div class="col-lg-12">
              <div class="card shadow h-100 mb-4" id="marketsCard">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                  <h6 class="m-0 font-weight-bold text-primary">Lista de Mercados</h6>
                  <div class="d-flex align-items-center">
                    <div class="input-group date-filter">
                      <input type="text" 
                            id="mercadosDateFilter" 
                            class="form-control form-control-sm" 
                            placeholder="dd/mm/yyyy"
                            maxlength="10"
                            autocomplete="off"
                            data-input-type="text"
                            pattern="[0-9]{2}/[0-9]{2}/[0-9]{4}">
                      <div class="input-group-append me-2">
                        <button id="clearDateFilter" class="btn btn-sm btn-outline-secondary" type="button">Limpar</button>
                      </div>
                      <div class="input-group-append me-2">
                        <a id="updateMarkets" class="btn btn-sm btn-success refresh-btn" title="atualizar mercados"><i class="bi bi-arrow-repeat"></i></a>
                      </div>
                      <div class="input-group-append">
                        <a id="mostrarCheckList" class="btn btn-sm btn-primary" title="Múltiplas"><i class="bi bi-list-check"></i></a>
                      </div>
                    </div>
                  </div>
                </div>
            
              
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-hover" id="marketsTable">
                      <thead class="text-center">
                        <tr style="font-size: smaller">
                          <th class="text-center col-id">ID</th>
                          <th class="text-center col-status">Status</th>
                          <th class="col-mercado">Evento</th>
                          <th class="text-center col-odd">Odd</th>
                          <th class="col-home">Home</th>
                          <th class="col-away">Away</th>
                          <th class="col-data">Data</th>
                          <th class="text-center col-acoes">Ações</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% if mercados %}
                          {% for mercado in mercados %}
                          <tr>
                            <td>
                              {% if mercado.resultado_estatistica %}
                                <i style="color:#198754;" class="bi bi-bar-chart-line-fill align-middle"></i>
                                <i style="color:#198754;" class="bi bi-tv align-middle"></i>
                              {% else %}
                                <i style="color:#dc3545;" class="bi bi-bar-chart-line-fill align-middle"></i>
                                <i class="bi bi-tv"></i>
                              {% endif %}
                              <span {% if mercado.resultado_estatistica %} 
                                class="btn-sucess resultado-statistic-overall-home"
                                {% else %}
                                class="resultado-statistic-overall-away"
                                {% endif %}>
                                <a class="eventBtn btn btn-sm btn-outline-light border-top-0 border-start-0 border-end-0 border-bottom-0 p-1 align-baseline font-weight-bold" 
                                  style="font-size: smaller"
                                  data-event-id="{{mercado.id_event}}"
                                  data-bs-toggle="tooltip"
                                  data-bs-placement="top"
                                  title="Registrar resultado entrada manualmente.">{{ mercado.id_event }}</a>
                              </span>
                            </td>
                            <td class="mercado-status">
                              <i {% if mercado.opcao_entrada == "A" %}
                                class="bi-check align-middle" style="font-size: 1rem; color: green;"
                                {% elif  mercado.opcao_entrada == "R" %}
                                class="bi bi-x align-middle" style="font-size: 1rem; color: red;"
                                {% else %}
                                class="bi-alarm align-middle" style="font-size: 1rem; color: cornflowerblue;"
                              {% endif %}></i>
                              {% if mercado.next_event_priority %}
                                <span class="icon-next-event-priority">
                                  <img src="{% static 'images/icons/next-event-priority.svg' %}" alt="next-event-priority" class="me-2r">
                                </span>
                              {% endif %}
                              {% if mercado.entry_result == "W" %}
                                <span class="icon-soccer">
                                  <img src="{% static 'images/icons/soccer.svg' %}" alt="soccer" class="me-2r" style="width: 15px; height: 15px;">
                                </span>
                              {% elif mercado.entry_result == "L" %}
                                <span class="icon-soccer-perdeu">
                                  <img src="{% static 'images/icons/soccer.svg' %}" alt="soccer" class="me-2r" style="width: 15px; height: 15px; background-color: red;">
                                </span>
                              {% elif mercado.entry_result == "D" %}
                                <span class="icon-soccer-empatou">
                                  <img src="{% static 'images/icons/soccer.svg' %}" alt="soccer" class="me-2r" style="width: 15px; height: 15px; background-color: #356adc; filter: hue-rotate(0deg) saturate(2) brightness(0.8) sepia(1) hue-rotate(-50deg);">
                                </span>
                              {% endif %}
                              {% if mercado.event_vote_home == "H" %}
                                <i style="color:#198754;" class="icon-vote align-middle fs-6 bi bi-house-up-fill"></i>
                              {% elif mercado.event_vote_home == "A" %}
                                <i style="color:#dc3545;" class="icon-vote align-middle fs-6 bi bi-house-down-fill"></i>
                              {% endif %}
                            </td>
                            <td class="mercado-column">
                                {{ mercado.mercado_name }}
                                {% if mercado.name_home and mercado.name_away %}
                                    {% if mercado.icon_home_data_url %}
                                        <img src="{{ mercado.icon_home_data_url }}"
                                            alt="Logo {{ mercado.name_home }}"
                                            class="team-logo"
                                            style="width: 20px; height: 20px; object-fit: contain;"
                                            onerror="this.style.display='none'">
                                    {% endif %}
                                    <span class="align-middle text-light-emphasis">{{ mercado.name_home }}</span> 
                                    <span class="align-middle text-light-emphasis">{{ mercado.mercado }}</span> 
                                    {% if mercado.icon_away_data_url %}
                                        <img src="{{ mercado.icon_away_data_url }}"
                                            alt="Logo {{ mercado.name_away }}"
                                            class="team-logo"
                                            style="width: 20px; height: 20px; object-fit: contain;"
                                            onerror="this.style.display='none'">
                                    {% endif %}
                                    <span class="align-middle text-light-emphasis">{{ mercado.name_away }}</span>
                                {% else %}
                                  {{ mercado.mercado }}
                                {% endif %}
                            </td>
                            <td class="text-light-emphasis">
                              <i {% if mercado.odd_change == 'P' %}
                                class="bi bi-stop align-middle" style="1rem; color: yellow;" 
                                {% elif mercado.odd_change == 'S' %}
                                class="bi bi-arrow-up-short align-middle align-middle" style="color: green;"
                                {% elif mercado.odd_change == 'D' %}
                                class="bi bi-arrow-down-short align-middle" style="color: red;"
                                {% endif %}></i>
                              {{ mercado.odd }}
                              <a id="atualizar-odd-change" class="btn btn-sm odd-change-btn" data-event-id="{{ mercado.id_event }}" title="Atualizar odd change">
                                <i class="bi bi-arrow-clockwise"></i>
                              </a>
                            </td>
                            <td class="text-light-emphasis">{{ mercado.home_actual }}%</td>
                            <td class="text-light-emphasis">{{ mercado.away_actual }}%</td>
                            <td class="text-light-emphasis">{{ mercado.data_jogo|date:"d/m/Y H:i:s" }}</td>
                            <td>
                              <div class="d-grid gap-4 d-md-block">
                                <a id="editar-odd" class="btn btn-sm btn-info edit-odd-btn" data-event-id="{{ mercado.id_event }}" title="Editar Odd">
                                  <i class="bi bi-pencil"></i>
                                </a>
                                <a id="aceitar-aposta" class="btn btn-sm btn-success apostar-btn" data-event-id="{{ mercado.id_event }}" data-event-orgin="score-data"  title="Aceitar aposta">
                                  <i class="bi bi-check"></i>
                                </a>
                                <a id="recusar-aposta" class="btn btn-sm btn-danger recusar-btn" data-event-id="{{ mercado.id_event }}" data-event-orgin="score-data" title="Recusar aposta">
                                  <i class="bi bi-x"></i>
                                </a>
                                <a id="desfazer-acao" class="btn btn-sm btn-warning desfazer-acao-btn" data-event-id="{{ mercado.id_event }}" data-event-orgin="score-data" title="Desfazer ação">
                                  <i class="bi bi-arrow-counterclockwise"></i>
                                </a>
                                <div class="btn-group" role="group">
                                  <a id="btnGroupDrop1" type="button" class="btn bg-body-secondary btn-sm" style="border-radius: inherit;" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="bi bi-three-dots-vertical"></i>
                                  </a>
                                  <ul class="dropdown-menu" aria-labelledby="btnGroupDrop1">
                                    <li><a class="dropdown-item event-vote" data-event-id="{{ mercado.id_event }}" data-event-orgin="score-data">Votacao</a></li>
                                    <li><a class="dropdown-item event-statistic" data-event-id="{{ mercado.id_event }}" data-event-orgin="score-data">Estatisticas</a></li>
                                    <li><a class="dropdown-item event-probability" data-event-id="{{ mercado.id_event }}" data-event-orgin="score-data">Probabilidade</a></li>
                                  </ul>
                                </div>
                              </div>
                            </td>
                          </tr>
                          {% endfor %}
                          {% endif %}
                      </tbody>
                    </table>
                  </div>
                  <!-- Componente de Paginação -->
                  <div class="pagination-container mt-3 d-flex justify-content-between align-items-center">
                    <div class="items-per-page">
                        <label class="me-2">Items por página:</label>
                        <select id="itemsPerPageSelect" class="form-select form-select-sm" style="width: auto; display: inline-block;">
                            <option value="10" {% if items_per_page == 10 %}selected{% endif %}>10</option>
                            <option value="20" {% if items_per_page == 20 %}selected{% endif %}>20</option>
                            <option value="30" {% if items_per_page == 30 %}selected{% endif %}>30</option>
                            <option value="50" {% if items_per_page == 50 %}selected{% endif %}>50</option>
                        </select>
                    </div>

                    <div class="pagination">
                      <ul class="pagination mb-0">
                          {% if mercados.has_previous %}
                              <li class="page-item">
                                  <a class="page-link" href="?page=1&items_per_page={{ items_per_page }}" aria-label="First">
                                      <span aria-hidden="true">&laquo;&laquo;</span>
                                  </a>
                              </li>
                              <li class="page-item">
                                  <a class="page-link" href="?page={{ mercados.previous_page_number }}&items_per_page={{ items_per_page }}" aria-label="Previous">
                                      <span aria-hidden="true">&laquo;</span>
                                  </a>
                              </li>
                          {% else %}
                              <li class="page-item disabled">
                                  <a class="page-link" href="#" aria-label="First">
                                      <span aria-hidden="true">&laquo;&laquo;</span>
                                  </a>
                              </li>
                              <li class="page-item disabled">
                                  <a class="page-link" href="#" aria-label="Previous">
                                      <span aria-hidden="true">&laquo;</span>
                                  </a>
                              </li>
                          {% endif %}
                          
                          {% if mercados.paginator.num_pages <= 10 %}
                              {% for i in mercados.paginator.page_range %}
                                  <li class="page-item {% if mercados.number == i %}active{% endif %}">
                                      <a class="page-link" href="?page={{ i }}&items_per_page={{ items_per_page }}">{{ i }}</a>
                                  </li>
                              {% endfor %}
                          {% else %}
                              {% for i in mercados.paginator.page_range %}
                                  {% if mercados.number == i %}
                                      <li class="page-item active">
                                          <span class="page-link">{{ i }}</span>
                                      </li>
                                  {% elif i > mercados.number|add:"-3" and i < mercados.number|add:"3" %}
                                      <li class="page-item">
                                          <a class="page-link" href="?page={{ i }}&items_per_page={{ items_per_page }}">{{ i }}</a>
                                      </li>
                                  {% endif %}
                              {% endfor %}
                          {% endif %}
                          
                          {% if mercados.has_next %}
                              <li class="page-item">
                                  <a class="page-link" href="?page={{ mercados.next_page_number }}&items_per_page={{ items_per_page }}" aria-label="Next">
                                      <span aria-hidden="true">&raquo;</span>
                                  </a>
                              </li>
                              <li class="page-item">
                                  <a class="page-link" href="?page={{ mercados.paginator.num_pages }}&items_per_page={{ items_per_page }}" aria-label="Last">
                                      <span aria-hidden="true">&raquo;&raquo;</span>
                                  </a>
                              </li>
                          {% else %}
                              <li class="page-item disabled">
                                  <a class="page-link" href="#" aria-label="Next">
                                      <span aria-hidden="true">&raquo;</span>
                                  </a>
                              </li>
                              <li class="page-item disabled">
                                  <a class="page-link" href="#" aria-label="Last">
                                      <span aria-hidden="true">&raquo;&raquo;</span>
                                  </a>
                              </li>
                          {% endif %}
                        </ul>
                    </div>
                    <div class="page-info">
                        <span>Página {{ mercados.number }} de {{ mercados.paginator.num_pages }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>  
            <div>
              {% include 'analytics/components/favorito_home.html' %}
            </div>
            <div>
              {% include 'analytics/components/owner_ball_mercado_super_favorito.html' %}
            </div>
            <div>
              {% include 'analytics/components/owner_ball_favorito_home.html' %}
            </div>
            <div>
              {% include 'analytics/components/owner_ball_under_2_5.html' %}
            </div>
          </div>
        </div>
      </div>

      <!-- Coluna direita: Mercados SF e OB (4 colunas) -->
      <div class="col-lg-3">
        <div class="sidebar-cards-container">
          
          <!-- Card Mercados SF -->
          <div class="card shadow mb-3">
            <div class="card-header py-2 d-flex align-items-center justify-content-between">
              <h6 class="m-0 font-weight-bold text-primary">Mercados SF</h6>
              <div class="d-flex align-items-center">
                <div class="form-check form-switch me-2">
                  <input class="form-check-input" type="checkbox" id="toggleAllSF">
                  <label class="form-check-label" for="toggleAllSF">
                    <small>Todos</small>
                  </label>
                </div>
                <button id="refreshOwnerBallBtn" class="btn btn-sm btn-success" title="Atualizar">
                  <i class="bi bi-arrow-repeat"></i>
                </button>
              </div>
            </div>
            <div class="card-body p-2 markets-scroll-container">
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="toggleSuperFavoritosHome">
                <label class="form-check-label" for="toggleSuperFavoritosHome">
                  Super Favoritos Home
                </label>
              </div>
              
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="toggleFavoritosHome">
                <label class="form-check-label" for="toggleFavoritosHome">
                  Favoritos Home
                </label>
              </div>
              
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="superFavoritosAway">
                <label class="form-check-label" for="superFavoritosAway">
                  Super Favoritos Away
                </label>
              </div>
              
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="favoritosAway">
                <label class="form-check-label" for="favoritosAway">
                  Favoritos Away
                </label>
              </div>
              
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="over15">
                <label class="form-check-label" for="over15">
                  Over 1.5
                </label>
              </div>

              <div class="form-check mb-1">
                <input class="form-check-input" type="checkbox" id="empates">
                <label class="form-check-label" for="empates">
                  Empates
                </label>
              </div>
            </div>
          </div>

          <!-- Card Mercados OB -->
          <div class="card shadow mb-3">
            <div class="card-header py-2 d-flex align-items-center justify-content-between">
              <h6 class="m-0 font-weight-bold text-primary">Mercados OB</h6>
              <div class="d-flex align-items-center">
                <div class="form-check form-switch me-2">
                  <input class="form-check-input" type="checkbox" id="toggleAllOwnerBall">
                  <label class="form-check-label" for="toggleAllOwnerBall">
                    <small>Todos</small>
                  </label>
                </div>
                <button id="refreshOwnerBallBtn" class="btn btn-sm btn-success" title="Atualizar">
                  <i class="bi bi-arrow-repeat"></i>
                </button>
              </div>
            </div>
            <div class="card-body p-2 markets-scroll-container">
              <div class="row g-1">
                <div class="col-6">
                  <div class="form-check mb-2">
                    <input class="form-check-input ownerball-check" type="checkbox" id="toggleOwnerBallSuperFavoritoHome">
                    <label class="form-check-label" for="toggleOwnerBallSuperFavoritoHome">
                      <small>Super Fav. Home</small>
                    </label>
                  </div>
                  
                  <div class="form-check mb-2">
                    <input class="form-check-input ownerball-check" type="checkbox" id="toggleOwnerBallFavoritoHome">
                    <label class="form-check-label" for="toggleOwnerBallFavoritoHome">
                      <small>Fav. Home</small>
                    </label>
                  </div>
                  
                  <div class="form-check mb-2">
                    <input class="form-check-input ownerball-check" type="checkbox" id="toggleOwnerBallUnder25">
                    <label class="form-check-label" for="toggleOwnerBallUnder25">
                      <small>Under 2.5</small>
                    </label>
                  </div>
                  
                  <div class="form-check mb-1">
                    <input class="form-check-input ownerball-check" type="checkbox" id="obDNB1">
                    <label class="form-check-label" for="obDNB1">
                      <small>DNB 1</small>
                    </label>
                  </div>
                </div>
                
                <div class="col-6">
                  <div class="form-check mb-2">
                    <input class="form-check-input ownerball-check" type="checkbox" id="obSuperFavAway">
                    <label class="form-check-label" for="obSuperFavAway">
                      <small>Super Fav. Away</small>
                    </label>
                  </div>
                  
                  <div class="form-check mb-2">
                    <input class="form-check-input ownerball-check" type="checkbox" id="obFavAway">
                    <label class="form-check-label" for="obFavAway">
                      <small>Fav. Away</small>
                    </label>
                  </div>
                  
                  <div class="form-check mb-2">
                    <input class="form-check-input ownerball-check" type="checkbox" id="obOver15Away">
                    <label class="form-check-label" for="obOver15Away">
                      <small>Over 1.5 Away</small>
                    </label>
                  </div>
                  
                  <div class="form-check mb-1">
                    <input class="form-check-input ownerball-check" type="checkbox" id="obDNB2">
                    <label class="form-check-label" for="obDNB2">
                      <small>DNB 2</small>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

{% endblock %}